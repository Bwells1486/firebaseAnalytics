{% extends 'base.html' %}
{% load static %}
{% block title %} Rogue Media | Dashboard {% endblock %}

{% block additional_stylesheets %}
<link href="{% static 'css/custom.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
{% endblock %}

{% block body %}

<div class="container">
    <div class="row">
        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
            <div class="tile job">
                <div class="header">
                    <div class="count">{{ total_users }}</div>
                    <div class="title">Total App Users</div>
                </div>
            </div>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <canvas id="instagramPie" width="400" height="400"></canvas>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-6 col-lg-4">
            <canvas id="twitterPie" width="400" height="400"></canvas>
        </div>
        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
            <div class="tile job">
                <div class="header">
                    <div class="count">{{ non_social_users }}</div>
                    <div class="title">Non Social Users</div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <canvas id="usersRD" width="400" height="400"></canvas>
        </div>
        <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
            <canvas id="usersGrowth" width=auto height=auto></canvas>
        </div>
    </div>
</div>

{{ users_with_insta|json_script:"insta-users" }}
{{ non_insta_users|json_script:"non-insta-users" }}
{{ users_with_twitter|json_script:"twitter-users" }}
{{ non_twitter_users|json_script:"non-twitter-users" }}
{{ total_users|json_script:"total-users"}}
{{ num_users_since|json_script:"num-users-since"}}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
<script>

// Extracting data from django script tags
const users_with_insta = JSON.parse(document.getElementById('insta-users').textContent);
const non_insta_users = JSON.parse(document.getElementById('non-insta-users').textContent);
const users_with_twitter = JSON.parse(document.getElementById('twitter-users').textContent);
const non_twitter_users = JSON.parse(document.getElementById('non-twitter-users').textContent);
const total_users = JSON.parse(document.getElementById('total-users').textContent);
const num_users_since = JSON.parse(document.getElementById('num-users-since').textContent);

// For testing & debugging - Printing to console
console.log(users_with_insta);
console.log(non_insta_users);
console.log(users_with_twitter);
console.log(non_twitter_users);
console.log(total_users);
console.log(num_users_since);

// Calculate percentage for Instagram users
var instaP = Math.round(users_with_insta*100/total_users);
var non_instaP = Math.round(non_insta_users*100/total_users);

// Calculate percentage for Twitter users
var twitterP = Math.round(users_with_twitter*100/total_users);
var non_twitterP = Math.round(non_twitter_users*100/total_users);

// Config for Charts
var insta_config = {
    type: 'pie',
    data: {
        labels: ['Insta Users '+instaP+'%', 'Non-Insta Users '+non_instaP+'%'],
        datasets: [{
            label: 'Connected Instagram Accounts',
            data: [instaP, non_instaP],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)'
            ],
            borderWidth: 1
        }]
    },
};

var twitter_config = {
    type: 'pie',
    data: {
        labels: ['Twitter User '+twitterP+'%', 'Non-Twitter User '+non_twitterP+'%'],
        datasets: [{
            label: 'Connected Twitter Accounts',
            data: [twitterP, non_twitterP],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)'
            ],
            borderWidth: 1
        }]
    },
};

var user_grwoth_config = {
  type: 'line',
  data: {
  labels: [{% for month, num_usr in months_ago.items %} '{{ month }}', {% endfor %}],
  datasets: [
    {
      label: 'User Growth',
      data: [{% for month, num_usr in months_ago.items %} {{ num_usr }}, {% endfor %}],
      borderColor: 'rgb(75, 192, 192)',
      backgroundColor: 'rgb(255, 255, 255)',
    }
  ]},
  options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Users Growth past 6 Months'
      }
    }
  },
};

// Pie Chart for Instagram Accounts
const ctxInsta = document.getElementById('instagramPie').getContext('2d');
const instagramPie = new Chart(ctxInsta, insta_config);

// Pie Chart for Twitter Accounts
const ctxTwitter = document.getElementById('twitterPie').getContext('2d');
const twitterPie = new Chart(ctxTwitter, twitter_config);

// Line Chart for Users Growth
const ctxUsersG = document.getElementById('usersGrowth').getContext('2d');
const usersGline = new Chart(ctxUsersG, user_grwoth_config);

const usersRDdata = {
  labels: [
    'Referrals',
    'Direct'
  ],
  datasets: [{
    label: 'Users',
    data: [{{ referred_users }}, {{ direct_users }}],
    backgroundColor: [
      'rgb(255, 99, 132)',
      'rgb(54, 162, 235)'
    ],
    hoverOffset: 4
  }]
};

const usersRDconfig = {
  type: 'doughnut',
  data: usersRDdata,
};

const ctxUsersRD = document.getElementById('usersRD').getContext('2d');
const usersRD = new Chart(ctxUsersRD, usersRDconfig);
</script>
{% endblock %}
